function createHelperPanel() {
  // Check if panel already exists
  if (document.getElementById('yt-treatment-helper')) {
    return;
  }

  // Log panel creation
  if (window.ExtensionLogger) {
    window.ExtensionLogger.logInfo('Helper panel created');
  }

  const panel = document.createElement('div');
  panel.id = 'yt-treatment-helper';
  panel.innerHTML = `
    <div class="helper-header">
      <div class="header-content">
        <span class="drag-handle">‚ãÆ‚ãÆ</span>
        <h3>Treatment Comparison</h3>
      </div>
      <button id="helper-close" class="helper-close-btn">√ó</button>
    </div>
    <div class="helper-body">

      <!-- Step 1: Treatment Date -->
      <div class="step-container" id="step-1">
        <div class="step-label">Select treatment date (DD/MM/YYYY)</div>
        <div class="input-section">
          <input type="text" id="treatment-date" class="date-input" placeholder="DD/MM/YYYY" maxlength="10" />
          <button id="calculate-btn" class="action-btn calculate-btn">Calculate</button>
        </div>
      </div>

      <!-- Step 2: Date Ranges -->
      <div id="results-section" class="results-section" style="display: none;">

        <div class="step-container">
          <div class="step-label-with-action">
            <span class="step-label">Calculated periods</span>
            <button id="edit-dates-btn" class="edit-link">Edit</button>
          </div>
        </div>

        <div class="periods-container">
          <div class="period-block pre-period">
            <div class="period-header">
              <span class="period-label">PRE</span>
              <span class="period-duration"><span id="pre-days">0</span>d</span>
            </div>
            <div class="period-dates-vertical">
              <div class="date-row">
                <label class="date-label">Start</label>
                <input type="text" id="pre-start" class="date-edit" placeholder="DD/MM/YYYY" maxlength="10" disabled />
              </div>
              <div class="date-row">
                <label class="date-label">End</label>
                <input type="text" id="pre-end" class="date-edit" placeholder="DD/MM/YYYY" maxlength="10" disabled />
              </div>
            </div>
          </div>

          <div class="period-block post-period">
            <div class="period-header">
              <span class="period-label">POST</span>
              <span class="period-duration"><span id="post-days">0</span>d</span>
            </div>
            <div class="period-dates-vertical">
              <div class="date-row">
                <label class="date-label">Start</label>
                <input type="text" id="post-start" class="date-edit" placeholder="DD/MM/YYYY" maxlength="10" disabled />
              </div>
              <div class="date-row">
                <label class="date-label">End</label>
                <input type="text" id="post-end" class="date-edit" placeholder="DD/MM/YYYY" maxlength="10" disabled />
              </div>
            </div>
          </div>
        </div>

        <!-- Info for period limitations -->
        <div id="period-warning" class="period-warning" style="display: none;">
          ‚ÑπÔ∏è Period length adjusted for fair comparison.
        </div>

        <!-- Error for invalid treatment date -->
        <div id="treatment-error" class="treatment-error" style="display: none;">
          ‚ùå Treatment date cannot be before the video was published!
        </div>

        <!-- Step 3: Extraction Mode Selection -->
        <div class="step-container" id="extraction-mode-section" style="display: none;">
          <div class="step-label">Choose extraction type</div>
          <div class="extraction-mode-options">
            <label class="radio-option">
              <input type="radio" name="extraction-mode" value="complete" checked>
              <div class="radio-content">
                <div class="radio-title">Complete Analysis</div>
                <div class="radio-description">Both equal periods and lifetime in one extraction</div>
              </div>
            </label>
            <label class="radio-option">
              <input type="radio" name="extraction-mode" value="equal-periods">
              <div class="radio-content">
                <div class="radio-title">Equal Periods</div>
                <div class="radio-description">For treatment comparison (spreadsheet)</div>
              </div>
            </label>
            <label class="radio-option">
              <input type="radio" name="extraction-mode" value="lifetime">
              <div class="radio-content">
                <div class="radio-title">Lifetime</div>
                <div class="radio-description">For Airtable (publish to treatment, publish to today)</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Step 4: Extract -->
        <div class="extract-controls">
          <button id="auto-extract-btn" class="action-btn extract-btn">
            <span class="btn-icon">üìä</span> Extract Metrics
          </button>
          <button id="cancel-extract-btn" class="cancel-btn" style="display: none;">Cancel</button>
        </div>

        <!-- Progress Bar -->
        <div id="progress-container" class="progress-container" style="display: none;">
          <div class="progress-wrapper">
            <div class="progress-bar">
              <div id="progress-fill" class="progress-fill"></div>
            </div>
            <div id="progress-percent" class="progress-percent">0%</div>
          </div>
        </div>

        <div id="extraction-status" class="extraction-status" style="display: none;"></div>

        <!-- Step 4: Results -->
        <div id="metrics-results" class="metrics-results" style="display: none;">
          <div class="metrics-grid">
            <div class="metrics-column pre-column">
              <div class="column-header">PRE</div>
              <div class="metric-row">
                <span class="metric-label">Impressions</span>
                <span id="pre-impressions" class="metric-value">‚Äî</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">CTR</span>
                <span id="pre-ctr" class="metric-value">‚Äî</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">Views</span>
                <span id="pre-views" class="metric-value">‚Äî</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">AWT</span>
                <span id="pre-awt" class="metric-value">‚Äî</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">Retention</span>
                <span id="pre-retention" class="metric-value">‚Äî</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">Stayed to watch</span>
                <span id="pre-stayed-to-watch" class="metric-value">‚Äî</span>
              </div>
              <button id="copy-pre-btn" class="copy-btn" data-period="pre"><span class="btn-icon">üìã</span> Copy Pre</button>
            </div>

            <div class="metrics-column post-column">
              <div class="column-header">POST</div>
              <div class="metric-row">
                <span class="metric-label">Impressions</span>
                <span id="post-impressions" class="metric-value">‚Äî</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">CTR</span>
                <span id="post-ctr" class="metric-value">‚Äî</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">Views</span>
                <span id="post-views" class="metric-value">‚Äî</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">AWT</span>
                <span id="post-awt" class="metric-value">‚Äî</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">Retention</span>
                <span id="post-retention" class="metric-value">‚Äî</span>
              </div>
              <div class="metric-row">
                <span class="metric-label">Stayed to watch</span>
                <span id="post-stayed-to-watch" class="metric-value">‚Äî</span>
              </div>
              <button id="copy-post-btn" class="copy-btn" data-period="post"><span class="btn-icon">üìã</span> Copy Post</button>
            </div>
          </div>

          <!-- Export section -->
          <div class="export-section">
            <div class="export-helper">
              <span class="export-icon">üìä</span>
              <div class="export-text">
                <div class="export-title">Export to Spreadsheet</div>
                <div class="export-subtitle">Paste into Google Sheets next to video title</div>
              </div>
            </div>
            <button id="copy-spreadsheet-btn" class="copy-btn export-btn">
              <span class="btn-icon">üìã</span> Copy for Spreadsheet
            </button>
          </div>
        </div>

        <!-- Complete Analysis Results -->
        <div id="complete-results" class="complete-results" style="display: none;">

          <!-- Equal Periods Section -->
          <div class="complete-section">
            <div class="section-title">Equal Periods Comparison</div>
            <div class="metrics-grid">
              <div class="metrics-column pre-column">
                <div class="column-header">PRE</div>
                <div class="metric-row">
                  <span class="metric-label">Impressions</span>
                  <span id="complete-equal-pre-impressions" class="metric-value">‚Äî</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">CTR</span>
                  <span id="complete-equal-pre-ctr" class="metric-value">‚Äî</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Views</span>
                  <span id="complete-equal-pre-views" class="metric-value">‚Äî</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">AWT</span>
                  <span id="complete-equal-pre-awt" class="metric-value">‚Äî</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Retention</span>
                  <span id="complete-equal-pre-retention" class="metric-value">‚Äî</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Stayed to watch</span>
                  <span id="complete-equal-pre-stayed-to-watch" class="metric-value">‚Äî</span>
                </div>
              </div>

              <div class="metrics-column post-column">
                <div class="column-header">POST</div>
                <div class="metric-row">
                  <span class="metric-label">Impressions</span>
                  <span id="complete-equal-post-impressions" class="metric-value">‚Äî</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">CTR</span>
                  <span id="complete-equal-post-ctr" class="metric-value">‚Äî</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Views</span>
                  <span id="complete-equal-post-views" class="metric-value">‚Äî</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">AWT</span>
                  <span id="complete-equal-post-awt" class="metric-value">‚Äî</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Retention</span>
                  <span id="complete-equal-post-retention" class="metric-value">‚Äî</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Stayed to watch</span>
                  <span id="complete-equal-post-stayed-to-watch" class="metric-value">‚Äî</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Lifetime Performance Section -->
          <div class="complete-section">
            <div class="section-title">Lifetime Performance</div>
            <div class="metrics-grid">
              <div class="metrics-column pre-column">
                <div class="column-header">PRE (Publish‚ÜíTreatment)</div>
                <div class="metric-row">
                  <span class="metric-label">Impressions</span>
                  <span id="complete-lifetime-pre-impressions" class="metric-value">‚Äî</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">CTR</span>
                  <span id="complete-lifetime-pre-ctr" class="metric-value">‚Äî</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Views</span>
                  <span id="complete-lifetime-pre-views" class="metric-value">‚Äî</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">AWT</span>
                  <span id="complete-lifetime-pre-awt" class="metric-value">‚Äî</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Retention</span>
                  <span id="complete-lifetime-pre-retention" class="metric-value">‚Äî</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Stayed to watch</span>
                  <span id="complete-lifetime-pre-stayed-to-watch" class="metric-value">‚Äî</span>
                </div>
              </div>

              <div class="metrics-column post-column">
                <div class="column-header">POST (Publish‚ÜíToday)</div>
                <div class="metric-row">
                  <span class="metric-label">Impressions</span>
                  <span id="complete-lifetime-post-impressions" class="metric-value">‚Äî</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">CTR</span>
                  <span id="complete-lifetime-post-ctr" class="metric-value">‚Äî</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Views</span>
                  <span id="complete-lifetime-post-views" class="metric-value">‚Äî</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">AWT</span>
                  <span id="complete-lifetime-post-awt" class="metric-value">‚Äî</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Retention</span>
                  <span id="complete-lifetime-post-retention" class="metric-value">‚Äî</span>
                </div>
                <div class="metric-row">
                  <span class="metric-label">Stayed to watch</span>
                  <span id="complete-lifetime-post-stayed-to-watch" class="metric-value">‚Äî</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Complete Export Section -->
          <div class="export-section">
            <div class="export-helper">
              <span class="export-icon">üìä</span>
              <div class="export-text">
                <div class="export-title">Export Complete Analysis</div>
                <div class="export-subtitle">All data in one row for spreadsheet</div>
              </div>
            </div>
            <button id="copy-complete-btn" class="copy-btn export-btn">
              <span class="btn-icon">üìã</span> Copy Complete Data
            </button>
          </div>
        </div>

      </div>
    </div>
  `;

  document.body.appendChild(panel);

  // Setup auto-formatting for date inputs
  const treatmentDateInput = document.getElementById('treatment-date');
  autoFormatDateInput(treatmentDateInput);

  // Make panel draggable
  makePanelDraggable(panel);

  // Check saved visibility state
  safeStorage.get(['panelVisible']).then((result) => {
    if (result.panelVisible === false) {
      panel.style.display = 'none';
    }
  });

  // Event Listeners
  document.getElementById('helper-close').addEventListener('click', async () => {
    panel.style.display = 'none';
    // Save state
    await safeStorage.set({ panelVisible: false });
  });

  document.getElementById('calculate-btn').addEventListener('click', async () => {
    const treatmentDateDDMMYYYY = document.getElementById('treatment-date').value;

    // Log user action
    if (window.ExtensionLogger) {
      window.ExtensionLogger.logUserAction('Calculate button clicked', { treatmentDate: treatmentDateDDMMYYYY });
    }

    if (!treatmentDateDDMMYYYY) {
      alert('Please enter a treatment date (DD/MM/YYYY)');
      if (window.ExtensionLogger) {
        window.ExtensionLogger.logWarning('Calculate clicked without treatment date');
      }
      return;
    }

    // Convert DD/MM/YYYY to YYYY-MM-DD for internal calculations
    const treatmentDate = formatDateToYYYYMMDD(treatmentDateDDMMYYYY);
    if (!treatmentDate) {
      alert('Invalid date format. Please use DD/MM/YYYY');
      return;
    }

    // Navigate to Analytics tab first to ensure we can get publish date
    try {
      await navigateToAnalyticsTab();
    } catch (error) {
      console.warn('Could not navigate to Analytics tab:', error);
    }

    // Wait a bit for Analytics page to load
    await new Promise(resolve => setTimeout(resolve, 500));

    // Try to get video publish date from Analytics page
    const videoPublishDate = getVideoPublishDate();

    if (videoPublishDate) {
      console.log(`‚úÖ Video publish date detected: ${formatDate(videoPublishDate)}`);

      // Set minimum date for treatment date picker to publish date
      const treatmentDateInput = document.getElementById('treatment-date');
      const publishDateStr = formatDate(videoPublishDate);
      treatmentDateInput.setAttribute('min', publishDateStr);
      console.log(`Set treatment date minimum to: ${publishDateStr}`);
    } else {
      console.warn('‚ö†Ô∏è Could not detect video publish date. PRE period may extend before video was published.');
    }

    // Validate: Treatment date cannot be before publish date
    const errorEl = document.getElementById('treatment-error');
    const warningEl = document.getElementById('period-warning');
    const extractBtn = document.getElementById('auto-extract-btn');

    if (videoPublishDate) {
      const treatment = new Date(treatmentDate);
      const publish = new Date(videoPublishDate);
      treatment.setHours(0, 0, 0, 0);
      publish.setHours(0, 0, 0, 0);

      if (treatment < publish) {
        // Treatment date is BEFORE video was published - this is invalid!
        console.error(`‚ùå Invalid: Treatment date ${formatDate(treatment)} is before publish date ${formatDate(publish)}`);

        // Show error message
        errorEl.style.display = 'block';
        warningEl.style.display = 'none';

        // Disable Extract button
        extractBtn.disabled = true;
        extractBtn.classList.add('disabled');

        // Still show the calculated periods (even though they're invalid) so user can see the problem
        document.getElementById('results-section').style.display = 'block';

        // Show "invalid" periods
        document.getElementById('pre-start').value = '';
        document.getElementById('pre-end').value = '';
        document.getElementById('pre-days').textContent = '‚Äî';

        // Convert treatment date to DD/MM/YYYY for display
        document.getElementById('post-start').value = formatDateToDDMMYYYY(treatmentDate);
        document.getElementById('post-start').dataset.original = treatmentDate;
        document.getElementById('post-end').value = '';
        document.getElementById('post-days').textContent = '‚Äî';

        // Scroll to show the error
        document.getElementById('results-section').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

        return; // Stop here - don't calculate ranges
      }
    }

    // Valid treatment date - proceed with calculation
    errorEl.style.display = 'none';
    extractBtn.disabled = false;
    extractBtn.classList.remove('disabled');

    let ranges;
    try {
      ranges = calculateDateRanges(treatmentDate, videoPublishDate);
    } catch (error) {
      alert(error.message);
      return;
    }

    // Display results (convert YYYY-MM-DD to DD/MM/YYYY for display)
    document.getElementById('pre-start').value = formatDateToDDMMYYYY(ranges.pre.start);
    document.getElementById('pre-start').dataset.original = ranges.pre.start; // Keep YYYY-MM-DD for calculations
    document.getElementById('pre-end').value = formatDateToDDMMYYYY(ranges.pre.end);
    document.getElementById('pre-end').dataset.original = ranges.pre.end;
    document.getElementById('pre-days').textContent = ranges.pre.days;

    document.getElementById('post-start').value = formatDateToDDMMYYYY(ranges.post.start);
    document.getElementById('post-start').dataset.original = ranges.post.start;
    document.getElementById('post-end').value = formatDateToDDMMYYYY(ranges.post.end);
    document.getElementById('post-end').dataset.original = ranges.post.end;
    document.getElementById('post-days').textContent = ranges.post.days;

    // Store video publish date for lifetime mode extraction
    if (videoPublishDate) {
      document.getElementById('pre-start').dataset.videoPublishDate = formatDate(videoPublishDate);
    }

    // Check if period was limited by publish date or available data
    const maxPossiblePostDays = ranges.daysSince + 1;
    const maxPossiblePreDays = ranges.videoPublishDate ?
      Math.floor((new Date(treatmentDate) - new Date(ranges.videoPublishDate)) / (1000 * 60 * 60 * 24)) :
      maxPossiblePostDays;

    if (ranges.pre.days < maxPossiblePostDays && maxPossiblePreDays < maxPossiblePostDays) {
      const warningMsg = `‚ÑπÔ∏è Using ${ranges.pre.days}-day periods (limited by video publish date on ${formatDateDisplay(ranges.videoPublishDate)}). ${maxPossiblePostDays - ranges.pre.days} days of POST data available but unused for fair comparison.`;
      console.log(warningMsg);

      // Show info in UI
      warningEl.innerHTML = warningMsg;
      warningEl.style.display = 'block';
      warningEl.style.background = '#e3f2fd';
      warningEl.style.color = '#1976d2';
    } else if (ranges.pre.days < maxPossiblePostDays) {
      const warningMsg = `‚ÑπÔ∏è Using ${ranges.pre.days}-day periods (limited by available POST data). Both periods are equal for fair comparison.`;
      console.log(warningMsg);

      // Show info in UI
      warningEl.innerHTML = warningMsg;
      warningEl.style.display = 'block';
      warningEl.style.background = '#e3f2fd';
      warningEl.style.color = '#1976d2';
    } else {
      // Hide warning if periods are equal
      warningEl.style.display = 'none';
    }

    document.getElementById('results-section').style.display = 'block';
    document.getElementById('extraction-mode-section').style.display = 'block';

    // Scroll to results
    document.getElementById('results-section').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    // Save to storage for future use (save in DD/MM/YYYY format for UI compatibility)
    safeStorage.set({
      lastTreatmentDate: treatmentDateDDMMYYYY,
      lastCalculatedRanges: ranges,
      videoPublishDate: videoPublishDate ? formatDate(videoPublishDate) : null
    });
  });

  // Helper: Calculate days between two dates
  function calculateDaysBetween(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    start.setHours(0, 0, 0, 0);
    end.setHours(0, 0, 0, 0);
    const diffTime = end - start;
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include both start and end
    return diffDays;
  }

  // Helper: Validate and update date ranges after manual edit
  function validateAndUpdateDateRanges() {
    const preStartDD = document.getElementById('pre-start').value;
    const preEndDD = document.getElementById('pre-end').value;
    const postStartDD = document.getElementById('post-start').value;
    const postEndDD = document.getElementById('post-end').value;
    const warningEl = document.getElementById('period-warning');
    const extractBtn = document.getElementById('auto-extract-btn');

    // Check all dates are filled
    if (!preStartDD || !preEndDD || !postStartDD || !postEndDD) {
      console.warn('Not all dates filled');
      return;
    }

    // Convert DD/MM/YYYY to YYYY-MM-DD for calculations
    const preStart = formatDateToYYYYMMDD(preStartDD);
    const preEnd = formatDateToYYYYMMDD(preEndDD);
    const postStart = formatDateToYYYYMMDD(postStartDD);
    const postEnd = formatDateToYYYYMMDD(postEndDD);

    if (!preStart || !preEnd || !postStart || !postEnd) {
      console.warn('Invalid date format');
      return;
    }

    // Update dataset.original with converted dates for extraction
    document.getElementById('pre-start').dataset.original = preStart;
    document.getElementById('pre-end').dataset.original = preEnd;
    document.getElementById('post-start').dataset.original = postStart;
    document.getElementById('post-end').dataset.original = postEnd;

    // Calculate days for each period
    const preDays = calculateDaysBetween(preStart, preEnd);
    const postDays = calculateDaysBetween(postStart, postEnd);

    // Update day displays
    document.getElementById('pre-days').textContent = preDays;
    document.getElementById('post-days').textContent = postDays;

    // Validate date order
    const preStartDate = new Date(preStart);
    const preEndDate = new Date(preEnd);
    const postStartDate = new Date(postStart);
    const postEndDate = new Date(postEnd);

    let hasError = false;
    let warningMsg = '';

    // Check: PRE start <= PRE end
    if (preStartDate > preEndDate) {
      warningMsg = '‚ùå PRE period: Start date must be before or equal to end date';
      hasError = true;
    }
    // Check: POST start <= POST end
    else if (postStartDate > postEndDate) {
      warningMsg = '‚ùå POST period: Start date must be before or equal to end date';
      hasError = true;
    }
    // Check: PRE end < POST start (periods shouldn't overlap)
    else if (preEndDate >= postStartDate) {
      warningMsg = '‚ùå PRE period must end before POST period starts';
      hasError = true;
    }
    // Check: Days are positive
    else if (preDays <= 0 || postDays <= 0) {
      warningMsg = '‚ùå Period must be at least 1 day long';
      hasError = true;
    }
    // Warning: Unequal periods
    else if (preDays !== postDays) {
      warningMsg = `‚ö†Ô∏è Warning: PRE (${preDays}d) and POST (${postDays}d) periods have different lengths. This may affect comparison fairness.`;
      hasError = false; // Warning, not error
    }

    // Show/hide warning
    if (warningMsg) {
      warningEl.innerHTML = warningMsg;
      warningEl.style.display = 'block';
      if (hasError) {
        warningEl.style.background = '#ffebee';
        warningEl.style.color = '#c62828';
        extractBtn.disabled = true;
        extractBtn.classList.add('disabled');
      } else {
        warningEl.style.background = '#fff3e0';
        warningEl.style.color = '#e65100';
        extractBtn.disabled = false;
        extractBtn.classList.remove('disabled');
      }
    } else {
      warningEl.style.display = 'none';
      extractBtn.disabled = false;
      extractBtn.classList.remove('disabled');
    }

    console.log(`Date ranges updated: PRE ${preDays}d, POST ${postDays}d`);

    // Log user action
    if (window.ExtensionLogger) {
      window.ExtensionLogger.logUserAction('Dates manually edited', {
        preStart, preEnd, preDays,
        postStart, postEnd, postDays,
        valid: !hasError
      });
    }
  }

  // Add change listeners to all date inputs
  document.querySelectorAll('.date-edit').forEach(input => {
    input.addEventListener('change', () => {
      validateAndUpdateDateRanges();
    });
  });

  // Edit dates button functionality
  panel.addEventListener('click', (e) => {
    const editBtn = e.target.closest('#edit-dates-btn');
    if (editBtn || e.target.id === 'edit-dates-btn') {
      e.preventDefault();
      e.stopPropagation();

      const dateInputs = document.querySelectorAll('.date-edit');
      const isEditing = editBtn.textContent.trim() === 'Done';

      if (isEditing) {
        // Save and lock - validate one final time
        validateAndUpdateDateRanges();

        dateInputs.forEach(input => {
          input.disabled = true;
          input.classList.remove('editable');
        });
        editBtn.textContent = 'Edit';
        editBtn.classList.remove('editing');
        console.log('Dates locked');

        // Log user action
        if (window.ExtensionLogger) {
          window.ExtensionLogger.logUserAction('Edit dates completed', {
            preStart: document.getElementById('pre-start').value,
            preEnd: document.getElementById('pre-end').value,
            postStart: document.getElementById('post-start').value,
            postEnd: document.getElementById('post-end').value
          });
        }
      } else {
        // Enable editing
        dateInputs.forEach(input => {
          input.disabled = false;
          input.classList.add('editable');
          // Add auto-formatting to each date input
          autoFormatDateInput(input);
        });
        editBtn.textContent = 'Done';
        editBtn.classList.add('editing');
        console.log('Dates now editable - enter dates in DD/MM/YYYY format');

        // Log user action
        if (window.ExtensionLogger) {
          window.ExtensionLogger.logUserAction('Edit dates started');
        }
      }
    }
  });

  // Copy period for Airtable functionality
  document.querySelectorAll('.copy-btn[data-period]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const button = e.currentTarget; // Use currentTarget to always get the button, not the clicked span
      const period = button.getAttribute('data-period');

      // Get metrics in order: CTR, Views, AWT, Retention
      const ctr = document.getElementById(`${period}-ctr`).textContent;
      const views = document.getElementById(`${period}-views`).textContent;
      const awt = formatDurationForSheets(document.getElementById(`${period}-awt`).textContent);
      const retention = document.getElementById(`${period}-retention`).textContent;

      // Format as tab-separated values for Airtable
      const airtableFormat = `${ctr}\t${views}\t${awt}\t${retention}`;

      navigator.clipboard.writeText(airtableFormat).then(() => {
        const originalText = button.textContent;
        button.textContent = 'Copied!';
        button.classList.add('copied');

        setTimeout(() => {
          button.textContent = originalText;
          button.classList.remove('copied');
        }, 1500);
      });
    });
  });

  // Helper: Format date ranges for spreadsheet
  const formatDateRangesForSpreadsheet = () => {
    // Get dates in YYYY-MM-DD format from dataset.original
    const preStart = document.getElementById('pre-start').dataset.original;
    const preEnd = document.getElementById('pre-end').dataset.original;
    const postStart = document.getElementById('post-start').dataset.original;
    const postEnd = document.getElementById('post-end').dataset.original;

    if (!preStart || !preEnd || !postStart || !postEnd) {
      return '';
    }

    // Convert YYYY-MM-DD to DD.MM.YYYY
    const formatDateDDMMYYYY = (dateStr) => {
      const [year, month, day] = dateStr.split('-');
      return `${day}.${month}.${year}`;
    };

    const preStartFormatted = formatDateDDMMYYYY(preStart);
    const preEndFormatted = formatDateDDMMYYYY(preEnd);
    const postStartFormatted = formatDateDDMMYYYY(postStart);
    const postEndFormatted = formatDateDDMMYYYY(postEnd);

    // Format as: "Pre - DD.MM.YYYY-DD.MM.YYYY Post- DD.MM.YYYY-DD.MM.YYYY"
    return `Pre - ${preStartFormatted}-${preEndFormatted} Post- ${postStartFormatted}-${postEndFormatted}`;
  };

  // Helper: Convert YYYY-MM-DD to DD.MM.YYYY
  const formatDateToDDMMYYYYWithDots = (dateStr) => {
    if (!dateStr) return '';
    // Handle YYYY-MM-DD format
    if (dateStr.includes('-')) {
      const [year, month, day] = dateStr.split('-');
      return `${day.padStart(2, '0')}.${month.padStart(2, '0')}.${year}`;
    }
    // Handle DD/MM/YYYY format - convert to DD.MM.YYYY
    if (dateStr.includes('/')) {
      return dateStr.replace(/\//g, '.');
    }
    return dateStr;
  };

  // Helper: Convert duration from YouTube format (1:23) to Google Sheets duration format (00:01:23)
  const formatDurationForSheets = (duration) => {
    if (!duration || duration === '‚Äî' || duration === 'N/A') return duration;

    // Parse YouTube duration format (could be m:ss or h:mm:ss)
    const parts = duration.split(':');

    if (parts.length === 2) {
      // Format is m:ss or mm:ss - convert to 00:mm:ss
      const minutes = parts[0].padStart(2, '0');
      const seconds = parts[1].padStart(2, '0');
      return `00:${minutes}:${seconds}`;
    } else if (parts.length === 3) {
      // Already in h:mm:ss format - just ensure 2-digit padding
      const hours = parts[0].padStart(2, '0');
      const minutes = parts[1].padStart(2, '0');
      const seconds = parts[2].padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }

    // If format is unexpected, return as-is
    return duration;
  };

  // Copy for Spreadsheet (Tab-separated)
  document.getElementById('copy-spreadsheet-btn').addEventListener('click', (e) => {
    const treatmentDate = formatDateRangesForSpreadsheet();
    const preImpressions = document.getElementById('pre-impressions').textContent;
    const postImpressions = document.getElementById('post-impressions').textContent;
    const preCtr = document.getElementById('pre-ctr').textContent;
    const postCtr = document.getElementById('post-ctr').textContent;
    const preAwt = formatDurationForSheets(document.getElementById('pre-awt').textContent);
    const postAwt = formatDurationForSheets(document.getElementById('post-awt').textContent);
    const preRetention = document.getElementById('pre-retention').textContent;
    const postRetention = document.getElementById('post-retention').textContent;
    const preViews = document.getElementById('pre-views').textContent;
    const postViews = document.getElementById('post-views').textContent;
    const preStayedToWatch = document.getElementById('pre-stayed-to-watch').textContent;
    const postStayedToWatch = document.getElementById('post-stayed-to-watch').textContent;

    // Format: treatment date, pre-impressions, post-impressions, empty, pre-ctr, post-ctr, empty, pre-awt, post-awt, pre-retention, post-retention, pre-stayed-to-watch, post-stayed-to-watch, pre-views, post-views
    // No leading tab so user can paste one column to the right of video title without overwriting it
    const tabFormat = `${treatmentDate}\t${preImpressions}\t${postImpressions}\t\t${preCtr}\t${postCtr}\t\t${preAwt}\t${postAwt}\t${preRetention}\t${postRetention}\t${preStayedToWatch}\t${postStayedToWatch}\t${preViews}\t${postViews}`;

    navigator.clipboard.writeText(tabFormat).then(() => {
      const btn = e.target.closest('button');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="btn-icon">‚úì</span> Copied!';
      btn.classList.add('copied');

      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('copied');
      }, 1500);
    });
  });

  // Copy Complete Analysis (Tab-separated with all data)
  document.getElementById('copy-complete-btn').addEventListener('click', (e) => {
    if (!window.completeAnalysisData) {
      alert('No data available. Please extract metrics first.');
      return;
    }

    const data = window.completeAnalysisData;

    // Format dates as DD.MM.YYYY
    const publishDate = formatDateToDDMMYYYYWithDots(data.dates.publishDate);
    const treatmentDate = formatDateToDDMMYYYYWithDots(data.dates.treatmentDate);
    const extractionDate = formatDateToDDMMYYYYWithDots(data.dates.extractionDate);

    // Equal Periods metrics
    const equalPreImpr = data.equal.pre.impressions || '';
    const equalPreViews = data.equal.pre.views || '';
    const equalPreCtr = data.equal.pre.ctr || '';
    const equalPreAwt = formatDurationForSheets(data.equal.pre.awt || '');
    const equalPreRet = data.equal.pre.retention?.value || '';
    const equalPreStw = data.equal.pre.stayedToWatch || '';

    const equalPostImpr = data.equal.post.impressions || '';
    const equalPostViews = data.equal.post.views || '';
    const equalPostCtr = data.equal.post.ctr || '';
    const equalPostAwt = formatDurationForSheets(data.equal.post.awt || '');
    const equalPostRet = data.equal.post.retention?.value || '';
    const equalPostStw = data.equal.post.stayedToWatch || '';

    // Lifetime metrics
    const lifePreImpr = data.lifetime.pre.impressions || '';
    const lifePreViews = data.lifetime.pre.views || '';
    const lifePreCtr = data.lifetime.pre.ctr || '';
    const lifePreAwt = formatDurationForSheets(data.lifetime.pre.awt || '');
    const lifePreRet = data.lifetime.pre.retention?.value || '';
    const lifePreStw = data.lifetime.pre.stayedToWatch || '';

    const lifePostImpr = data.lifetime.post.impressions || '';
    const lifePostViews = data.lifetime.post.views || '';
    const lifePostCtr = data.lifetime.post.ctr || '';
    const lifePostAwt = formatDurationForSheets(data.lifetime.post.awt || '');
    const lifePostRet = data.lifetime.post.retention?.value || '';
    const lifePostStw = data.lifetime.post.stayedToWatch || '';

    // Format: Dates (3) | Equal Periods with Change columns (18) | Separators (2) | Lifetime with Change columns (18)
    // Total: 41 columns
    const tabFormat = [
      publishDate,
      treatmentDate,
      extractionDate,
      // Equal Periods: PRE | POST | Change (empty) for each metric
      equalPreImpr,
      equalPostImpr,
      '', // Change
      equalPreViews,
      equalPostViews,
      '', // Change
      equalPreCtr,
      equalPostCtr,
      '', // Change
      equalPreAwt,
      equalPostAwt,
      '', // Change
      equalPreRet,
      equalPostRet,
      '', // Change
      equalPreStw,
      equalPostStw,
      '', // Change
      '', // separator
      '', // separator
      // Lifetime: PRE | POST | Change (empty) for each metric
      lifePreImpr,
      lifePostImpr,
      '', // Change
      lifePreViews,
      lifePostViews,
      '', // Change
      lifePreCtr,
      lifePostCtr,
      '', // Change
      lifePreAwt,
      lifePostAwt,
      '', // Change
      lifePreRet,
      lifePostRet,
      '', // Change
      lifePreStw,
      lifePostStw,
      '' // Change
    ].join('\t');

    navigator.clipboard.writeText(tabFormat).then(() => {
      const btn = e.target.closest('button');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="btn-icon">‚úì</span> Copied!';
      btn.classList.add('copied');

      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('copied');
      }, 1500);
    });
  });

  // Auto-Extract button functionality with retry logic
  let extractionAttempts = 0;
  const maxAttempts = 2;
  let extractionCancelled = false;
  let partialData = { pre: null, post: null };

  // Tab change detection
  let wasHidden = false;
  document.addEventListener('visibilitychange', () => {
    const autoExtractBtn = document.getElementById('auto-extract-btn');
    if (document.hidden && autoExtractBtn && autoExtractBtn.disabled) {
      wasHidden = true;
    } else if (!document.hidden && wasHidden) {
      wasHidden = false;
      const statusEl = document.getElementById('extraction-status');
      if (statusEl && statusEl.style.display !== 'none') {
        statusEl.innerHTML = '‚ö†Ô∏è Tab was switched during extraction. Results may be incomplete.<br>Please try again.';
        statusEl.className = 'extraction-status error';
      }
    }
  });

  // Cancel button
  document.getElementById('cancel-extract-btn').addEventListener('click', () => {
    extractionCancelled = true;
    const statusEl = document.getElementById('extraction-status');
    statusEl.textContent = 'üõë Extraction cancelled by user';
    statusEl.className = 'extraction-status error';
    document.getElementById('cancel-extract-btn').style.display = 'none';
    document.getElementById('auto-extract-btn').disabled = false;
    document.getElementById('progress-container').style.display = 'none';
  });

  const runExtraction = async (isRetry = false) => {
    // Use dataset.original which stores YYYY-MM-DD format for internal use
    const preStart = document.getElementById('pre-start').dataset.original;
    const preEnd = document.getElementById('pre-end').dataset.original;
    const postStart = document.getElementById('post-start').dataset.original;
    const postEnd = document.getElementById('post-end').dataset.original;

    const statusEl = document.getElementById('extraction-status');
    const autoExtractBtn = document.getElementById('auto-extract-btn');
    const cancelBtn = document.getElementById('cancel-extract-btn');
    const progressContainer = document.getElementById('progress-container');
    const progressFill = document.getElementById('progress-fill');
    const progressPercent = document.getElementById('progress-percent');

    let currentStep = '';
    let totalSteps = 18; // Granular progress with 18 steps
    let currentStepNum = 0;

    const updateProgress = (step, stepNum) => {
      currentStep = step;
      currentStepNum = stepNum;
      const percentage = Math.round((stepNum / totalSteps) * 100);

      // Store progress in DOM for persistence across page changes
      progressContainer.dataset.currentStep = stepNum;
      progressContainer.dataset.currentPercentage = percentage;

      // Apply visual updates - force style to persist
      progressFill.style.width = `${percentage}%`;
      progressPercent.textContent = `${percentage}%`;
      statusEl.textContent = step;

      // Force layout recalculation to ensure changes are applied
      void progressFill.offsetHeight;
    };

    extractionCancelled = false;

    try {
      // Show UI
      statusEl.style.display = 'block';
      statusEl.className = 'extraction-status';
      autoExtractBtn.disabled = true;
      cancelBtn.style.display = 'block';
      progressContainer.style.display = 'block';

      // Restore progress if this is a retry or continuation
      if (progressContainer.dataset.currentStep && !isRetry) {
        const savedStep = parseInt(progressContainer.dataset.currentStep);
        const savedPercentage = parseInt(progressContainer.dataset.currentPercentage);
        progressFill.style.width = `${savedPercentage}%`;
        progressPercent.textContent = `${savedPercentage}%`;
        currentStepNum = savedStep;
      }

      updateProgress('Starting extraction...', 0);

      // Check if on Advanced Mode page
      if (!window.location.href.includes('/explore?')) {
        updateProgress('üîÑ Navigating to Advanced Mode...', 0);
        await navigateToAdvancedMode();
        if (extractionCancelled) throw new Error('Cancelled by user');
      }

      const updateStatus = (message) => {
        if (extractionCancelled) throw new Error('Cancelled by user');

        // Map messages to step numbers (18 granular steps total)
        if (message.includes('Opening metrics picker')) updateProgress(message, 1);
        else if (message.includes('Selecting required metrics')) updateProgress(message, 2);
        else if (message.includes('Opening date picker for PRE')) updateProgress(message, 3);
        else if (message.includes('Setting PRE period dates')) updateProgress(message, 4);
        else if (message.includes('Waiting for PRE data')) updateProgress(message, 5);
        else if (message.includes('Reading PRE metrics')) updateProgress(message, 6);
        else if (message.includes('Opening date picker for POST')) updateProgress(message, 7);
        else if (message.includes('Setting POST period dates')) updateProgress(message, 8);
        else if (message.includes('Waiting for POST data')) updateProgress(message, 9);
        else if (message.includes('Reading POST metrics')) updateProgress(message, 10);
        else if (message.includes('Opening report menu')) updateProgress(message, 11);
        else if (message.includes('Switching to Audience Retention')) updateProgress(message, 12);
        else if (message.includes('Waiting for retention chart')) updateProgress(message, 13);
        else if (message.includes('Setting PRE dates for retention')) updateProgress(message, 14);
        else if (message.includes('Reading PRE retention')) updateProgress(message, 15);
        else if (message.includes('Setting POST dates for retention')) updateProgress(message, 16);
        else if (message.includes('Reading POST retention')) updateProgress(message, 17);
        else if (message.includes('Switching back to metrics')) updateProgress(message, 18);
        else statusEl.textContent = message;
      };

      // Run extraction (always include retention)
      currentStep = 'Extracting metrics';
      const result = await extractPrePostMetrics(
        preStart, preEnd,
        postStart, postEnd,
        updateStatus,
        true // Always extract retention
      );

      // Display results
      document.getElementById('pre-impressions').textContent = result.pre.impressions || '‚Äî';
      document.getElementById('pre-views').textContent = result.pre.views || '‚Äî';
      document.getElementById('pre-ctr').textContent = result.pre.ctr || '‚Äî';
      document.getElementById('pre-awt').textContent = result.pre.awt || '‚Äî';
      document.getElementById('pre-retention').textContent = result.pre.retention?.value || 'N/A';
      document.getElementById('pre-stayed-to-watch').textContent = result.pre.stayedToWatch || '‚Äî';

      document.getElementById('post-impressions').textContent = result.post.impressions || '‚Äî';
      document.getElementById('post-views').textContent = result.post.views || '‚Äî';
      document.getElementById('post-ctr').textContent = result.post.ctr || '‚Äî';
      document.getElementById('post-awt').textContent = result.post.awt || '‚Äî';
      document.getElementById('post-retention').textContent = result.post.retention?.value || 'N/A';
      document.getElementById('post-stayed-to-watch').textContent = result.post.stayedToWatch || '‚Äî';

      // Update displayed date ranges based on extraction mode
      if (window.currentExtractionMode === 'lifetime') {
        // For lifetime mode, update the displayed dates to show the actual ranges used
        // PRE: publish ‚Üí treatment
        document.getElementById('pre-start').value = formatDateToDDMMYYYY(preStart);
        document.getElementById('pre-end').value = formatDateToDDMMYYYY(preEnd);
        const preDays = calculateDaysBetween(preStart, preEnd);
        document.getElementById('pre-days').textContent = preDays;

        // POST: publish ‚Üí today
        document.getElementById('post-start').value = formatDateToDDMMYYYY(postStart);
        document.getElementById('post-end').value = formatDateToDDMMYYYY(postEnd);
        const postDays = calculateDaysBetween(postStart, postEnd);
        document.getElementById('post-days').textContent = postDays;

        // Show Copy Pre/Post buttons for Airtable, hide spreadsheet button
        document.getElementById('copy-pre-btn').style.display = 'inline-flex';
        document.getElementById('copy-post-btn').style.display = 'inline-flex';
        document.getElementById('copy-spreadsheet-btn').parentElement.style.display = 'none';
      } else {
        // Equal periods mode: show spreadsheet button, hide individual copy buttons
        document.getElementById('copy-pre-btn').style.display = 'none';
        document.getElementById('copy-post-btn').style.display = 'none';
        document.getElementById('copy-spreadsheet-btn').parentElement.style.display = 'block';
      }

      document.getElementById('metrics-results').style.display = 'block';

      // Scroll to bottom to show results
      const helperBody = document.querySelector('.helper-body');
      if (helperBody) {
        setTimeout(() => {
          helperBody.scrollTo({
            top: helperBody.scrollHeight,
            behavior: 'smooth'
          });
        }, 100);
      }

      updateProgress('‚úÖ Complete!', totalSteps);
      statusEl.textContent = '‚úÖ Metrics extracted successfully!';
      statusEl.className = 'extraction-status success';
      cancelBtn.style.display = 'none';

      // Reset attempt counter on success
      extractionAttempts = 0;

      // Log successful extraction
      if (window.ExtensionLogger) {
        window.ExtensionLogger.logInfo('Extraction completed successfully', {
          preStart,
          preEnd,
          postStart,
          postEnd,
          metrics: {
            pre: result.pre,
            post: result.post
          }
        });
      }

      // Save to storage
      safeStorage.set({
        lastExtractedMetrics: result
      });

    } catch (error) {
      console.error('Extraction failed:', error);

      // Log extraction error
      if (window.ExtensionLogger) {
        window.ExtensionLogger.logError('Extraction failed', error, {
          currentStep,
          currentStepNum,
          extractionAttempts,
          isRetry,
          preStart,
          preEnd,
          postStart,
          postEnd
        });
      }

      extractionAttempts++;
      cancelBtn.style.display = 'none';

      // Check if cancelled
      if (error.message === 'Cancelled by user') {
        if (window.ExtensionLogger) {
          window.ExtensionLogger.logInfo('Extraction cancelled by user');
        }
        return; // Already handled by cancel button
      }

      // Check if it's an extension context error
      if (!isExtensionContextValid()) {
        statusEl.innerHTML = `‚ùå Extension reloaded. Please <strong>refresh this page</strong> (F5) to continue.`;
        statusEl.className = 'extraction-status error';
        progressContainer.style.display = 'none';
        alert('The extension was reloaded.\n\nPlease refresh this page (press F5) and try again.');

        if (window.ExtensionLogger) {
          window.ExtensionLogger.logError('Extension context invalid during extraction', error);
        }
      } else {
        // Build helpful error message
        let errorMsg = `‚ùå Failed at: ${currentStep}\n`;
        errorMsg += `Error: ${error.message}`;

        if (extractionAttempts < maxAttempts && !isRetry) {
          // First failure - auto-retry after 2 seconds
          errorMsg += `\n\nüîÑ Auto-retrying in 2 seconds...`;
          statusEl.innerHTML = errorMsg.replace(/\n/g, '<br>');
          statusEl.className = 'extraction-status error';

          if (window.ExtensionLogger) {
            window.ExtensionLogger.logInfo('Auto-retrying extraction after failure', {
              attempt: extractionAttempts
            });
          }

          await new Promise(resolve => setTimeout(resolve, 2000));
          return runExtraction(true); // Retry
        } else {
          // Second failure - suggest page refresh
          errorMsg += `\n\nüí° Please refresh the page (F5) and try again.`;
          statusEl.innerHTML = errorMsg.replace(/\n/g, '<br>');
          statusEl.className = 'extraction-status error';
          progressContainer.style.display = 'none';

          // Show alert for critical failures
          if (error.message.includes('not found') || error.message.includes('Timeout')) {
            alert('Extraction failed twice.\n\nPlease:\n1. Refresh the page (F5)\n2. Make sure you\'re on a video analytics page\n3. Try again');
          }
        }
      }
    } finally {
      autoExtractBtn.disabled = false;
    }
  };

  // Complete Analysis function
  const runCompleteAnalysis = async (ranges) => {
    const autoExtractBtn = document.getElementById('auto-extract-btn');
    const statusEl = document.getElementById('extraction-status');
    const cancelBtn = document.getElementById('cancel-extract-btn');

    autoExtractBtn.disabled = true;
    statusEl.style.display = 'block';
    cancelBtn.style.display = 'inline-block';

    try {
      // Hide existing single-mode results
      document.getElementById('metrics-results').style.display = 'none';

      // Navigate to Advanced Mode if not already there
      if (!window.location.href.includes('/explore?')) {
        statusEl.textContent = 'üîÑ Navigating to Advanced Mode...';
        statusEl.className = 'extraction-status info';
        await navigateToAdvancedMode();
      }

      // Step 1: Extract Equal Periods data
      statusEl.textContent = 'üìä Extracting equal periods data...';
      statusEl.className = 'extraction-status info';

      const equalResult = await extractPrePostMetrics(
        ranges.equalPreStart, ranges.equalPreEnd,
        ranges.equalPostStart, ranges.equalPostEnd,
        (msg) => { statusEl.textContent = msg; },
        true
      );

      // Step 2: Extract Lifetime data
      statusEl.textContent = 'üìä Extracting lifetime data...';

      const lifetimeResult = await extractPrePostMetrics(
        ranges.lifetimePreStart, ranges.lifetimePreEnd,
        ranges.lifetimePostStart, ranges.lifetimePostEnd,
        (msg) => { statusEl.textContent = msg; },
        true
      );

      // Store both results globally
      window.completeAnalysisData = {
        equal: equalResult,
        lifetime: lifetimeResult,
        dates: {
          publishDate: ranges.lifetimePreStart,
          treatmentDate: ranges.lifetimePreEnd,
          extractionDate: formatDate(new Date())
        }
      };

      // Display Equal Periods results
      document.getElementById('complete-equal-pre-impressions').textContent = equalResult.pre.impressions || '‚Äî';
      document.getElementById('complete-equal-pre-views').textContent = equalResult.pre.views || '‚Äî';
      document.getElementById('complete-equal-pre-ctr').textContent = equalResult.pre.ctr || '‚Äî';
      document.getElementById('complete-equal-pre-awt').textContent = equalResult.pre.awt || '‚Äî';
      document.getElementById('complete-equal-pre-retention').textContent = equalResult.pre.retention?.value || 'N/A';
      document.getElementById('complete-equal-pre-stayed-to-watch').textContent = equalResult.pre.stayedToWatch || '‚Äî';

      document.getElementById('complete-equal-post-impressions').textContent = equalResult.post.impressions || '‚Äî';
      document.getElementById('complete-equal-post-views').textContent = equalResult.post.views || '‚Äî';
      document.getElementById('complete-equal-post-ctr').textContent = equalResult.post.ctr || '‚Äî';
      document.getElementById('complete-equal-post-awt').textContent = equalResult.post.awt || '‚Äî';
      document.getElementById('complete-equal-post-retention').textContent = equalResult.post.retention?.value || 'N/A';
      document.getElementById('complete-equal-post-stayed-to-watch').textContent = equalResult.post.stayedToWatch || '‚Äî';

      // Display Lifetime results
      document.getElementById('complete-lifetime-pre-impressions').textContent = lifetimeResult.pre.impressions || '‚Äî';
      document.getElementById('complete-lifetime-pre-views').textContent = lifetimeResult.pre.views || '‚Äî';
      document.getElementById('complete-lifetime-pre-ctr').textContent = lifetimeResult.pre.ctr || '‚Äî';
      document.getElementById('complete-lifetime-pre-awt').textContent = lifetimeResult.pre.awt || '‚Äî';
      document.getElementById('complete-lifetime-pre-retention').textContent = lifetimeResult.pre.retention?.value || 'N/A';
      document.getElementById('complete-lifetime-pre-stayed-to-watch').textContent = lifetimeResult.pre.stayedToWatch || '‚Äî';

      document.getElementById('complete-lifetime-post-impressions').textContent = lifetimeResult.post.impressions || '‚Äî';
      document.getElementById('complete-lifetime-post-views').textContent = lifetimeResult.post.views || '‚Äî';
      document.getElementById('complete-lifetime-post-ctr').textContent = lifetimeResult.post.ctr || '‚Äî';
      document.getElementById('complete-lifetime-post-awt').textContent = lifetimeResult.post.awt || '‚Äî';
      document.getElementById('complete-lifetime-post-retention').textContent = lifetimeResult.post.retention?.value || 'N/A';
      document.getElementById('complete-lifetime-post-stayed-to-watch').textContent = lifetimeResult.post.stayedToWatch || '‚Äî';

      // Show complete results section
      document.getElementById('complete-results').style.display = 'block';

      // Scroll to bottom
      const helperBody = document.querySelector('.helper-body');
      if (helperBody) {
        setTimeout(() => {
          helperBody.scrollTo({
            top: helperBody.scrollHeight,
            behavior: 'smooth'
          });
        }, 100);
      }

      statusEl.textContent = '‚úÖ Complete analysis extracted successfully!';
      statusEl.className = 'extraction-status success';
      cancelBtn.style.display = 'none';

    } catch (error) {
      console.error('Complete analysis failed:', error);
      statusEl.textContent = `‚ùå Failed: ${error.message}`;
      statusEl.className = 'extraction-status error';
      cancelBtn.style.display = 'none';
    } finally {
      autoExtractBtn.disabled = false;
    }
  };

  // Extract button click handler
  document.getElementById('auto-extract-btn').addEventListener('click', async () => {
    // Check which extraction mode is selected
    const extractionMode = document.querySelector('input[name="extraction-mode"]:checked').value;

    // Store extraction mode globally so copy buttons know which format to use
    window.currentExtractionMode = extractionMode;

    if (extractionMode === 'complete') {
      // Complete analysis: Extract both equal periods and lifetime
      const treatmentDate = document.getElementById('treatment-date').value;
      const treatmentDateYYYYMMDD = formatDateToYYYYMMDD(treatmentDate);
      const videoPublishDateStr = document.getElementById('pre-start').dataset.videoPublishDate;

      if (!videoPublishDateStr || !treatmentDateYYYYMMDD) {
        alert('Please calculate date ranges first');
        return;
      }

      // Log user action
      if (window.ExtensionLogger) {
        window.ExtensionLogger.logUserAction('Extract button clicked (Complete Analysis mode)');
      }

      // Store calculated equal periods ranges
      const equalPreStart = document.getElementById('pre-start').dataset.original;
      const equalPreEnd = document.getElementById('pre-end').dataset.original;
      const equalPostStart = document.getElementById('post-start').dataset.original;
      const equalPostEnd = document.getElementById('post-end').dataset.original;

      // Calculate lifetime ranges
      const today = new Date();
      today.setDate(today.getDate() - 2);
      const todayStr = formatDate(today);

      // Run complete analysis
      await runCompleteAnalysis({
        equalPreStart,
        equalPreEnd,
        equalPostStart,
        equalPostEnd,
        lifetimePreStart: videoPublishDateStr,
        lifetimePreEnd: treatmentDateYYYYMMDD,
        lifetimePostStart: videoPublishDateStr,
        lifetimePostEnd: todayStr
      });

      return; // Exit early since we have a separate function for complete analysis
    } else if (extractionMode === 'lifetime') {
      // Calculate lifetime ranges: publish ‚Üí treatment, publish ‚Üí today
      const treatmentDate = document.getElementById('treatment-date').value;
      const treatmentDateYYYYMMDD = formatDateToYYYYMMDD(treatmentDate);

      // Get video publish date (stored during calculate)
      const videoPublishDateStr = document.getElementById('pre-start').dataset.videoPublishDate;

      if (!videoPublishDateStr || !treatmentDateYYYYMMDD) {
        alert('Please calculate date ranges first');
        return;
      }

      // Calculate today (or yesterday, as YouTube data is typically 2 days behind)
      const today = new Date();
      today.setDate(today.getDate() - 2); // YouTube data is ~2 days behind
      const todayStr = formatDate(today);

      // Set lifetime ranges in dataset.original for extraction
      // PRE: publish ‚Üí treatment
      document.getElementById('pre-start').dataset.original = videoPublishDateStr;
      document.getElementById('pre-end').dataset.original = treatmentDateYYYYMMDD;

      // POST: publish ‚Üí today
      document.getElementById('post-start').dataset.original = videoPublishDateStr;
      document.getElementById('post-end').dataset.original = todayStr;

      // Log user action
      if (window.ExtensionLogger) {
        window.ExtensionLogger.logUserAction('Extract button clicked (Lifetime mode)', {
          prePeriod: `${videoPublishDateStr} to ${treatmentDateYYYYMMDD}`,
          postPeriod: `${videoPublishDateStr} to ${todayStr}`
        });
      }
    } else {
      // Equal periods mode - use existing calculated ranges
      const preStart = document.getElementById('pre-start').value;
      const preEnd = document.getElementById('pre-end').value;
      const postStart = document.getElementById('post-start').value;
      const postEnd = document.getElementById('post-end').value;

      // Log user action
      if (window.ExtensionLogger) {
        window.ExtensionLogger.logUserAction('Extract button clicked (Equal Periods mode)', {
          preStart,
          preEnd,
          postStart,
          postEnd
        });
      }

      if (!preStart || !preEnd || !postStart || !postEnd) {
        alert('Please calculate date ranges first');
        if (window.ExtensionLogger) {
          window.ExtensionLogger.logWarning('Extract clicked without date ranges');
        }
        return;
      }
    }

    await runExtraction(false);
  });


  // Load last used treatment date if available
  safeStorage.get(['lastTreatmentDate']).then((result) => {
    if (result.lastTreatmentDate) {
      let dateToDisplay = result.lastTreatmentDate;

      // Handle backward compatibility: if stored date is YYYY-MM-DD, convert to DD/MM/YYYY
      if (dateToDisplay.includes('-')) {
        dateToDisplay = formatDateToDDMMYYYY(dateToDisplay);
      }

      document.getElementById('treatment-date').value = dateToDisplay;
    }
  });
}
